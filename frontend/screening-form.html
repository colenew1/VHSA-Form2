<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Health Screening Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #4A90E2;
      --accent: #FFB84D;
      --success: #4CAF50;
      --error: #F44336;
      --text: #2C3E50;
      --bg: #FDFBF7;
      --border: #E5E5E5;
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .tab {
      transition: all 0.3s;
    }
    
    .tab.active {
      background: var(--primary);
      color: white;
    }
    
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .accordion-content.open {
      max-height: 5000px;
      transition: max-height 0.5s ease-in;
    }
    
    .accordion-icon {
      transition: transform 0.3s;
    }
    
    .accordion.open .accordion-icon {
      transform: rotate(180deg);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      max-width: 500px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .success-icon {
      font-size: 60px;
      color: var(--success);
      text-align: center;
      margin-bottom: 20px;
    }
    
    .student-id-display {
      background: #f0f8ff;
      border: 2px dashed var(--primary);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }
    
    .student-id-display div {
      font-size: 32px;
      font-weight: bold;
      color: var(--primary);
      margin-top: 10px;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    button {
      cursor: pointer;
    }
    
    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .required-badge {
      background-color: #FFB84D;
      color: #2C3E50;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    
    .accordion-header-text {
      display: flex;
      align-items: center;
      flex: 1;
    }
  </style>
</head>
<body class="min-h-screen py-8 px-4">
  
  <!-- Header -->
  <header class="max-w-6xl mx-auto mb-8 text-center">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">School Health Screening Form</h1>
    <p class="text-lg text-gray-600">Vision & Hearing Screening of Austin</p>
  </header>

  <!-- Main Form Container -->
  <main class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
    
    <!-- SECTION 1: Screening Details -->
    <section id="screeningDetails" class="mb-8">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Screening Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Screening Date *</label>
            <input type="date" id="screeningDate" required 
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Screener Name <span class="text-red-500 font-bold">*</span>
            </label>
            <select id="screenerName" required onchange="autoFillScreener()" 
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500 invalid:border-red-500">
              <option value="">Select Screener</option>
            </select>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Global Screening Type</label>
          <select id="globalScreeningType" onchange="applyGlobalScreeningType()" 
                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
            <option value="initial" selected>Initial Screen</option>
            <option value="rescreen">Rescreen</option>
          </select>
          <p class="text-xs text-gray-600 mt-1">This will set all screening types below. You can change individual tests if needed.</p>
        </div>

        <div class="mb-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="absent" onchange="absentChanged(this.checked)" 
                   class="w-5 h-5 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
            <span class="font-semibold text-gray-700">Student was absent</span>
          </label>
        </div>
      </div>
    </section>

    <!-- SECTION 2: Find or Create Student -->
    <section id="studentSection" class="mb-8">
      <!-- Tabs -->
      <div class="flex border-b-2 border-gray-200 mb-6">
        <button id="searchTabBtn" class="tab flex-1 py-3 px-4 font-semibold text-gray-700 hover:bg-gray-100 active" onclick="switchTab('search')">
          Search Student
        </button>
        <button id="newTabBtn" class="tab flex-1 py-3 px-4 font-semibold text-gray-700 hover:bg-gray-100" onclick="switchTab('new')">
          New Student
        </button>
      </div>
      
      <!-- Search Tab Content -->
      <div id="searchTab" class="tab-content">
        <div class="space-y-6">
          <!-- Search by ID -->
          <div class="bg-blue-50 p-4 rounded-lg">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Search by Student ID</label>
            <div class="flex gap-2">
              <input type="text" id="searchId" placeholder="Enter student ID" 
                     class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                     oninput="this.value = this.value.toLowerCase()">
              <button onclick="searchById()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">
                Search
              </button>
            </div>
          </div>

          <!-- Divider -->
          <div class="flex items-center gap-4">
            <div class="flex-1 border-t border-gray-300"></div>
            <span class="text-gray-500 font-semibold">OR</span>
            <div class="flex-1 border-t border-gray-300"></div>
          </div>

          <!-- Search by Name -->
          <div class="bg-green-50 p-4 rounded-lg">
            <label class="block text-sm font-semibold text-gray-700 mb-3">Search by Name</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
              <input type="text" id="searchLastName" placeholder="Last Name" 
                     class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
              <select id="searchSchool" class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                <option value="">Select School</option>
              </select>
            </div>
            <button onclick="searchByName()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700">
              Search by Name
            </button>
          </div>

          <!-- Search Results -->
          <div id="searchResults" class="hidden">
            <div id="multipleResults" class="hidden">
              <p class="text-sm text-gray-600 mb-3">Multiple students found. Please select one:</p>
              <div id="studentList" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- New Student Tab Content -->
      <div id="newTab" class="tab-content hidden">
        <form id="newStudentForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">First Name *</label>
              <input type="text" id="firstName" required 
                     class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name *</label>
              <input type="text" id="lastName" required 
                     class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Grade *</label>
              <select id="grade" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Select Grade</option>
                <option value="Pre-K (3)">Pre-K (3)</option>
                <option value="Pre-K (4)">Pre-K (4)</option>
                <option value="Kindergarten">Kindergarten</option>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
                <option value="3rd">3rd</option>
                <option value="4th">4th</option>
                <option value="5th">5th</option>
                <option value="6th">6th</option>
                <option value="7th">7th</option>
                <option value="8th">8th</option>
                <option value="9th">9th</option>
                <option value="10th">10th</option>
                <option value="11th">11th</option>
                <option value="12th">12th</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Gender *</label>
              <select id="gender" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">School *</label>
            <select id="newStudentSchool" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select School</option>
            </select>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Teacher Last Name</label>
              <input type="text" id="teacher" 
                     class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Date of Birth *</label>
              <input type="date" id="dob" required 
                     class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Student Status *</label>
            <select id="status" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select Status</option>
              <option value="New">New</option>
              <option value="Returning">Returning</option>
            </select>
          </div>

          <button type="button" onclick="createNewStudent()" 
                  class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 text-lg">
            Create Student & Continue
          </button>
        </form>
      </div>
    </section>

    <!-- SECTION 3: Student Information -->
    <section id="studentInfo" class="hidden mb-8">
      <div class="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-300 rounded-lg p-6">
        <div class="mb-4">
          <h2 class="text-2xl font-bold text-gray-800">Student Information</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600">Student ID</label>
            <div id="displayStudentId" class="text-2xl font-bold text-blue-600"></div>
          </div>
          <div>
            <label class="text-sm text-gray-600">Name</label>
            <div id="displayName" class="text-lg font-semibold text-gray-800"></div>
          </div>
          <div>
            <label class="text-sm text-gray-600">Grade | Gender | School</label>
            <div id="displayDetails" class="text-gray-700"></div>
          </div>
          <div>
            <label class="text-sm text-gray-600">Teacher Last Name | DOB | Student Status</label>
            <div id="displayAdditional" class="text-gray-700"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Student Absent Checkbox -->
    <section id="absentSection" class="hidden mb-8">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <div class="mb-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="absent" onchange="absentChanged(this.checked)" 
                   class="w-5 h-5 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
            <span class="font-semibold text-gray-700">Student was absent</span>
          </label>
        </div>
      </div>
    </section>

    <!-- SECTION 4: Screening Tests -->
    <section id="screeningTests" class="hidden space-y-4">
      
      <!-- Info Box -->
      <div class="info-box bg-blue-50 p-4 mb-4 rounded-lg border-l-4 border-blue-500">
        <p class="text-sm text-gray-700">
          <strong>Note:</strong> Sections marked <span class="required-badge" style="display: inline-block;">Required</span> must be completed based on this student's grade, gender, and status. Other sections are optional but can still be completed if needed.
        </p>
      </div>
      
      <!-- Vision Accordion -->
      <div class="accordion border border-gray-300 rounded-lg overflow-hidden" data-section="vision">
        <button class="accordion-header w-full flex justify-between items-center p-4 bg-blue-50 hover:bg-blue-100 font-semibold text-left" onclick="toggleAccordion('vision')">
          <span class="accordion-header-text">
            Vision Screening
            <span class="required-badge" id="visionBadge" style="display: none;">Required</span>
          </span>
          <span class="accordion-icon">‚ñº</span>
        </button>
        <div class="accordion-content" data-section="vision">
          <div class="p-4 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Glasses</label>
                <div class="flex gap-4">
                  <label class="flex items-center gap-2"><input type="radio" name="visionGlasses" value="yes" class="text-blue-600"> Yes</label>
                  <label class="flex items-center gap-2"><input type="radio" name="visionGlasses" value="no" class="text-blue-600" checked> No</label>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Result</label>
                <div class="flex gap-4">
                  <label class="flex items-center gap-2"><input type="radio" name="visionResult" value="pass" onchange="visionResultChanged('pass')" class="text-green-600"> Pass</label>
                  <label class="flex items-center gap-2"><input type="radio" name="visionResult" value="fail" onchange="visionResultChanged('fail')" class="text-red-600"> Fail</label>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Right Eye</label>
                <select id="visionRightEye" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Select</option>
                  <option value="20">20</option>
                  <option value="30">30</option>
                  <option value="40">40</option>
                  <option value="50">50</option>
                  <option value="60">60</option>
                  <option value="70">70</option>
                  <option value="80">80</option>
                  <option value="90">90</option>
                  <option value="100">100</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Left Eye</label>
                <select id="visionLeftEye" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Select</option>
                  <option value="20">20</option>
                  <option value="30">30</option>
                  <option value="40">40</option>
                  <option value="50">50</option>
                  <option value="60">60</option>
                  <option value="70">70</option>
                  <option value="80">80</option>
                  <option value="90">90</option>
                  <option value="100">100</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hearing Accordion -->
      <div class="accordion border border-gray-300 rounded-lg overflow-hidden" data-section="hearing">
        <button class="accordion-header w-full flex justify-between items-center p-4 bg-green-50 hover:bg-green-100 font-semibold text-left" onclick="toggleAccordion('hearing')">
          <span class="accordion-header-text">
            Hearing Screening
            <span class="required-badge" id="hearingBadge" style="display: none;">Required</span>
          </span>
          <span class="accordion-icon">‚ñº</span>
        </button>
        <div class="accordion-content" data-section="hearing">
          <div class="p-4 space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Result</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2"><input type="radio" name="hearingResult" value="pass" onchange="hearingResultChanged('pass')" class="text-green-600"> Pass</label>
                <label class="flex items-center gap-2"><input type="radio" name="hearingResult" value="fail" onchange="hearingResultChanged('fail')" class="text-red-600"> Fail</label>
              </div>
            </div>
            <div id="hearingFrequencies" class="hidden">
              <p class="text-sm font-semibold text-gray-700 mb-2">Frequency Response (check failed frequencies):</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p class="text-sm font-semibold text-gray-700 mb-1">Right Ear</p>
                  <div class="space-y-1">
                    <label class="flex items-center gap-2"><input type="checkbox" class="hearing-freq" data-ear="right" data-freq="1000" class="text-red-600"> 1000 Hz</label>
                    <label class="flex items-center gap-2"><input type="checkbox" class="hearing-freq" data-ear="right" data-freq="2000" class="text-red-600"> 2000 Hz</label>
                    <label class="flex items-center gap-2"><input type="checkbox" class="hearing-freq" data-ear="right" data-freq="4000" class="text-red-600"> 4000 Hz</label>
                  </div>
                </div>
                <div>
                  <p class="text-sm font-semibold text-gray-700 mb-1">Left Ear</p>
                  <div class="space-y-1">
                    <label class="flex items-center gap-2"><input type="checkbox" class="hearing-freq" data-ear="left" data-freq="1000" class="text-red-600"> 1000 Hz</label>
                    <label class="flex items-center gap-2"><input type="checkbox" class="hearing-freq" data-ear="left" data-freq="2000" class="text-red-600"> 2000 Hz</label>
                    <label class="flex items-center gap-2"><input type="checkbox" class="hearing-freq" data-ear="left" data-freq="4000" class="text-red-600"> 4000 Hz</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Acanthosis Accordion -->
      <div class="accordion border border-gray-300 rounded-lg overflow-hidden" data-section="acanthosis">
        <button class="accordion-header w-full flex justify-between items-center p-4 bg-purple-50 hover:bg-purple-100 font-semibold text-left" onclick="toggleAccordion('acanthosis')">
          <span class="accordion-header-text">
            Acanthosis Screening
            <span class="required-badge" id="acanthosisBadge" style="display: none;">Required</span>
          </span>
          <span class="accordion-icon">‚ñº</span>
        </button>
        <div class="accordion-content" data-section="acanthosis">
          <div class="p-4 space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Result</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2"><input type="radio" name="acanthosisResult" value="pass" class="text-green-600"> Pass</label>
                <label class="flex items-center gap-2"><input type="radio" name="acanthosisResult" value="fail" class="text-red-600"> Fail</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scoliosis Accordion -->
      <div class="accordion border border-gray-300 rounded-lg overflow-hidden" data-section="scoliosis">
        <button class="accordion-header w-full flex justify-between items-center p-4 bg-pink-50 hover:bg-pink-100 font-semibold text-left" onclick="toggleAccordion('scoliosis')">
          <span class="accordion-header-text">
            Scoliosis Screening
            <span class="required-badge" id="scoliosisBadge" style="display: none;">Required</span>
          </span>
          <span class="accordion-icon">‚ñº</span>
        </button>
        <div class="accordion-content" data-section="scoliosis">
          <div class="p-4 space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Observations (select all that apply)</label>
              <div class="space-y-2">
                <label class="flex items-center">
                  <input type="checkbox" name="scoliosisObs" value="Uneven shoulder" class="mr-2">
                  <span class="text-sm">Uneven shoulder</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="scoliosisObs" value="Uneven scapula" class="mr-2">
                  <span class="text-sm">Uneven scapula</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="scoliosisObs" value="Accentuated waist crease on one side" class="mr-2">
                  <span class="text-sm">Accentuated waist crease on one side</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="scoliosisObs" value="Unequal arm body space visible" class="mr-2">
                  <span class="text-sm">Unequal arm body space visible</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="scoliosisObs" value="Lateral curvature of the spine prominence on one side" class="mr-2">
                  <span class="text-sm">Lateral curvature of the spine prominence on one side</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="scoliosisObs" value="Forward bending position" class="mr-2">
                  <span class="text-sm">Forward bending position</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="scoliosisObs" value="Accentuated round back/kyphosis" class="mr-2">
                  <span class="text-sm">Accentuated round back/kyphosis</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="scoliosisObs" value="Accentuated sway back/lordosis" class="mr-2">
                  <span class="text-sm">Accentuated sway back/lordosis</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" name="scoliosisObs" value="Other see additional notes" class="mr-2">
                  <span class="text-sm">Other (see additional notes)</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Result</label>
              <div class="flex gap-4">
                <label class="flex items-center gap-2"><input type="radio" name="scoliosisResult" value="pass" class="text-green-600"> Pass</label>
                <label class="flex items-center gap-2"><input type="radio" name="scoliosisResult" value="fail" class="text-red-600"> Fail</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </section>

    <!-- SECTION 5: Additional Notes -->
    <section id="notesSection" class="hidden mt-8">
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Additional Notes</h2>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
          <textarea id="notes" rows="3" 
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"></textarea>
        </div>
      </div>
    </section>

    <!-- SECTION 6: Submit -->
    <section id="submitSection" class="hidden mt-8 pt-8 border-t-2 border-gray-300">
      <button onclick="submitScreening()" 
              class="w-full bg-green-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-green-700">
        ‚úì Submit Screening Results
      </button>
    </section>

    <!-- Clear Form Button - Always Visible -->
    <section class="mt-8 pt-8 border-t-2 border-gray-300">
      <button onclick="resetForm()" 
              class="w-full px-6 py-4 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
        Clear Form
      </button>
    </section>

  </main>

  <!-- New Student Success Modal -->
  <div id="newStudentModal" class="modal">
    <div class="modal-content">
      <div class="success-icon">‚úì</div>
      <h2 class="text-2xl font-bold text-center mb-4">New Student Created Successfully</h2>
      <div class="student-id-display">
        <label class="text-sm text-gray-600">Student ID:</label>
        <div id="newStudentId"></div>
      </div>
      <div class="student-info space-y-2 mb-4">
        <p><strong>Name:</strong> <span id="newStudentName"></span></p>
        <p><strong>Grade:</strong> <span id="newStudentGrade"></span></p>
        <p><strong>School:</strong> <span id="newStudentSchoolName"></span></p>
      </div>
      <p class="text-center text-orange-600 font-semibold mb-4">üìù Write this ID on the student's label!</p>
      <div class="flex gap-3">
        <button onclick="continueToScreening()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700">
          Continue to Screening
        </button>
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
          Done
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div id="editStudentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold text-red-600 mb-2">Incomplete Student Data</h3>
      <p class="text-gray-700 mb-4">This student record is missing required information. Please fill in the missing fields below:</p>
      
      <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
        <p class="text-sm text-gray-700"><strong>Student ID:</strong> <span id="editStudentId"></span></p>
      </div>
      
      <form id="editStudentForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">First Name *</label>
            <input type="text" id="editFirstName" required
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name *</label>
            <input type="text" id="editLastName" required
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Grade *</label>
            <select id="editGrade" required
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select Grade</option>
              <option value="Pre-K (3)">Pre-K (3)</option>
              <option value="Pre-K (4)">Pre-K (4)</option>
              <option value="Kindergarten">Kindergarten</option>
              <option value="1st">1st</option>
              <option value="2nd">2nd</option>
              <option value="3rd">3rd</option>
              <option value="4th">4th</option>
              <option value="5th">5th</option>
              <option value="6th">6th</option>
              <option value="7th">7th</option>
              <option value="8th">8th</option>
              <option value="9th">9th</option>
              <option value="10th">10th</option>
              <option value="11th">11th</option>
              <option value="12th">12th</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Gender *</label>
            <select id="editGender" required
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">School *</label>
            <select id="editSchool" required
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select School</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Teacher Last Name</label>
            <input type="text" id="editTeacher"
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Date of Birth *</label>
            <input type="date" id="editDOB" required
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Student Status *</label>
            <select id="editStatus" required
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select Status</option>
              <option value="New">New</option>
              <option value="Returning">Returning</option>
            </select>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="closeEditStudentModal()" 
                  class="px-6 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
          <button type="button" onclick="saveStudentUpdates()" 
                  class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Save & Continue
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Automatically detect environment and set API base URL
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000/api'  // Local Express server
      : '/api'; // Use relative URLs for production (Netlify)
    
    // Add cache-busting parameter for API calls
    const CACHE_BUST = `?v=${Date.now()}`;
    // Add debugging information
    console.log('Page loaded, API_BASE:', API_BASE);

    // Helper function for title case formatting
    function toTitleCase(str) {
      if (!str) return '';
      return str
        .trim()
        .toLowerCase()
        .split(' ')
        .map(word => {
          if (word.length === 0) return '';
          return word.charAt(0).toUpperCase() + word.slice(1);
        })
        .join(' ');
    }
    console.log('Cache bust parameter:', CACHE_BUST);
    
    // Test API connection immediately
    fetch(`${API_BASE}/health${CACHE_BUST}`)
      .then(response => response.json())
      .then(data => {
        console.log('Health check response:', data);
        if (data.supabase === 'connected') {
          console.log('‚úÖ Database connection confirmed');
        } else {
          console.log('‚ùå Database connection issue:', data);
        }
      })
      .catch(error => {
        console.error('‚ùå Health check failed:', error);
      });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadSchools();
      await loadScreeners();
      setDefaultDate();
      
      // Ensure absent checkbox starts unchecked
      document.getElementById('absent').checked = false;
    });

    // Load schools from API
    async function loadSchools() {
      try {
        const response = await fetch(`${API_BASE}/schools${CACHE_BUST}`);
        const data = await response.json();
        
        // Check if response has error
        if (!response.ok || data.error) {
          console.error('Error loading schools:', data.error || 'Unknown error');
          schools = [];
          return;
        }
        
        schools = data;
        const searchSelect = document.getElementById('searchSchool');
        const newSelect = document.getElementById('newStudentSchool');
        
        if (Array.isArray(schools)) {
          schools.forEach(school => {
            const option1 = new Option(school.name, school.name);
            const option2 = new Option(school.name, school.name);
            searchSelect.add(option1);
            newSelect.add(option2);
          });
        }
        
        // Add "Other" option at the bottom
        const otherOption1 = new Option('Other', 'other');
        const otherOption2 = new Option('Other', 'other');
        searchSelect.add(otherOption1);
        newSelect.add(otherOption2);
      } catch (error) {
        console.error('Error loading schools:', error);
        schools = [];
      }
    }

    // Load screeners from API
    async function loadScreeners() {
      try {
        const response = await fetch(`${API_BASE}/screeners${CACHE_BUST}`);
        const data = await response.json();
        
        // Check if response has error
        if (!response.ok || data.error) {
          console.error('Error loading screeners:', data.error || 'Unknown error');
          screeners = [];
        } else {
          screeners = data;
        }
        
        // Define all screener dropdowns
        const screenerDropdowns = [
          'screenerName',
          'visionDay1Screener',
          'hearingDay1Screener',
          'acanthosisDay1Screener',
          'scoliosisDay1Screener'
        ];
        
        // Populate all dropdowns with screeners (only if they're empty to avoid duplicates)
        screenerDropdowns.forEach(id => {
          const select = document.getElementById(id);
          if (select && select.options.length <= 1) { // Only populate if empty or has only "Select Screener" option
            // Clear existing options except the first one
            while (select.options.length > 0) {
              select.remove(0);
            }
            
            // Add "Select Screener" placeholder for main dropdown
            if (id === 'screenerName') {
              select.add(new Option('Select Screener', ''));
            }
            
            // Add all screeners from API first
            if (Array.isArray(screeners)) {
              screeners.forEach(screener => {
                select.add(new Option(screener.name, screener.name));
              });
            }
            
            // Add "Other" at the bottom
            select.add(new Option('Other', 'other'));
          }
        });
      } catch (error) {
        console.error('Error loading screeners:', error);
        screeners = [];
        // Even if API fails, ensure "Other" option exists
        const screenerDropdowns = ['visionDay1Screener', 'hearingDay1Screener', 'acanthosisDay1Screener', 'scoliosisDay1Screener'];
        screenerDropdowns.forEach(id => {
          const select = document.getElementById(id);
          if (select && select.options.length <= 1) {
            if (select.options.length === 0 || select.options[0].value === '') {
              select.innerHTML = '';
              select.add(new Option('Other', 'other'));
            }
          }
        });
      }
    }

    // Auto-fill screener to all sections when main screener changes
    function autoFillScreener() {
      const mainScreener = document.getElementById('screenerName').value;
      if (!mainScreener) return;
      
      // Auto-fill to all individual screener dropdowns
      document.getElementById('visionDay1Screener').value = mainScreener;
      document.getElementById('hearingDay1Screener').value = mainScreener;
      document.getElementById('acanthosisDay1Screener').value = mainScreener;
      document.getElementById('scoliosisDay1Screener').value = mainScreener;
    }

    // Set default date to today
    function setDefaultDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('screeningDate').value = today;
      
      // Also set today's date for all individual screening section date fields
      document.getElementById('visionDay1Date').value = today;
      document.getElementById('hearingDay1Date').value = today;
      document.getElementById('acanthosisDay1Date').value = today;
      document.getElementById('scoliosisDay1Date').value = today;
    }

    // Tab switching
    function switchTab(tabName) {
      // Update tab buttons
      document.getElementById('searchTabBtn').classList.remove('active');
      document.getElementById('newTabBtn').classList.remove('active');
      
      if (tabName === 'search') {
        document.getElementById('searchTabBtn').classList.add('active');
        document.getElementById('searchTab').classList.remove('hidden');
        document.getElementById('newTab').classList.add('hidden');
      } else {
        document.getElementById('newTabBtn').classList.add('active');
        document.getElementById('searchTab').classList.add('hidden');
        document.getElementById('newTab').classList.remove('hidden');
      }
      
      // Clear search results
      document.getElementById('searchResults').classList.add('hidden');
      document.getElementById('multipleResults').classList.add('hidden');
    }

    // Search by student ID
    async function searchById() {
      console.log('üîç searchById function called');
      const studentId = document.getElementById('searchId').value.trim().toLowerCase();
      console.log('üîç Student ID:', studentId);
      
      if (!studentId) {
        showCustomPopup('warning', 'Missing Student ID', 'Please enter a student ID');
        return;
      }

      console.log('üîç Making API call to:', `${API_BASE}/students/${studentId}${CACHE_BUST}`);
      
      try {
        const response = await fetch(`${API_BASE}/students/${studentId}${CACHE_BUST}`);
        console.log('üîç Response status:', response.status);
        const data = await response.json();
        console.log('üîç Response data:', data);
        
        if (!response.ok) {
          console.error('‚ùå API Error:', response.status, data);
          showCustomPopup('error', 'API Error', `Error: ${response.status} - ${data.error || 'Unknown error'}`);
          return;
        }
        
        if (!data.found) {
          showCustomPopup('warning', 'Student Not Found', 'Student not found. Please check the student ID and try again.');
          return;
        }
        
        console.log('üîç Loading student data:', data.student);
        loadStudentData(data.student, data.requiredScreenings);
      } catch (error) {
        console.error('üí• Error searching for student:', error);
        showCustomPopup('error', 'Connection Error', 'Error connecting to the database. Please try again later.');
      }
    }

    // Search by name
    async function searchByName() {
      const lastName = document.getElementById('searchLastName').value.trim();
      const school = document.getElementById('searchSchool').value;
      
      console.log('üîç searchByName called with:', { lastName, school });
      
      if (!lastName) {
        showCustomPopup('warning', 'Missing Information', 'Please enter a last name');
        return;
      }
      
      if (!school) {
        showCustomPopup('warning', 'Missing Information', 'Please select a school');
        return;
      }
      
      try {
        console.log('üîç Searching for:', lastName, 'at', school);
        
        const url = `${API_BASE}/students/search?lastName=${encodeURIComponent(lastName)}&school=${encodeURIComponent(school)}&v=${Date.now()}`;
        console.log('üîç API URL:', url);
        
        const response = await fetch(url);
        console.log('üîç Response status:', response.status);
        
        if (!response.ok) {
          const errorData = await response.json();
          console.error('‚ùå API Error:', response.status, errorData);
          showCustomPopup('error', 'API Error', `Error: ${response.status} - ${errorData.error || 'Unknown error'}`);
          return;
        }
        
        const data = await response.json();
        console.log('üîç Response data:', data);
        console.log('üîç data.found:', data.found);
        console.log('üîç typeof data.found:', typeof data.found);
        console.log('üîç !data.found:', !data.found);
        
        if (!data.found) {
          console.log('‚ùå Student not found - showing popup');
          showCustomPopup('warning', 'Student Not Found', 'No students found with that name at this school');
          return;
        }
        
        if (data.multiple) {
          console.log('üîç Multiple students found:', data.students.length);
          // Show multiple results
          document.getElementById('searchResults').classList.remove('hidden');
          document.getElementById('multipleResults').classList.remove('hidden');
          const listDiv = document.getElementById('studentList');
          listDiv.innerHTML = '';
          
          data.students.forEach(student => {
            const div = document.createElement('div');
            div.className = 'bg-white border border-gray-300 rounded-lg p-3 hover:bg-gray-50 cursor-pointer';
            div.innerHTML = `
              <div class="font-semibold">${student.first_name} ${student.last_name}</div>
              <div class="text-sm text-gray-600">ID: ${student.unique_id} | Grade: ${student.grade} | School: ${student.school}</div>
            `;
            div.onclick = () => searchByIdWithId(student.unique_id);
            listDiv.appendChild(div);
          });
        } else {
          console.log('üîç Single student found:', data.student);
          loadStudentData(data.student, data.requiredScreenings);
          document.getElementById('searchResults').classList.add('hidden');
          document.getElementById('multipleResults').classList.add('hidden');
        }
        
      } catch (error) {
        console.error('üí• Search error:', error);
        showCustomPopup('error', 'Search Error', 'Error searching for student: ' + error.message);
      }
    }

    async function searchByIdWithId(id) {
      document.getElementById('searchId').value = id;
      await searchById();
    }

    // Create new student
    async function createNewStudent() {
      // Get and format values with title case
      const firstName = toTitleCase(document.getElementById('firstName').value);
      const lastName = toTitleCase(document.getElementById('lastName').value);
      const grade = document.getElementById('grade').value;
      const gender = document.getElementById('gender').value;
      const school = document.getElementById('newStudentSchool').value;
      const teacher = toTitleCase(document.getElementById('teacher').value);
      const dob = document.getElementById('dob').value;
      const status = document.getElementById('status').value;

      // Validation
      if (!firstName || !lastName || !grade || !gender || !school || !dob || !status) {
        showCustomPopup('warning', 'Missing Information', 'Please fill in all required fields (marked with *)');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/students/quick-add${CACHE_BUST}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            firstName, lastName, grade, gender, school, teacher, dob, status
          })
        });

        const data = await response.json();
        
        if (data.success) {
          // Show modal with new student info
          document.getElementById('newStudentId').textContent = data.student.unique_id;
          document.getElementById('newStudentName').textContent = `${data.student.first_name} ${data.student.last_name}`;
          document.getElementById('newStudentGrade').textContent = data.student.grade;
          document.getElementById('newStudentSchoolName').textContent = data.student.school;
          document.getElementById('newStudentModal').style.display = 'block';
          
          // Store for continuation
          window.newStudentData = { student: data.student, requiredScreenings: data.requiredScreenings };
        } else {
          showCustomPopup('error', 'Error', 'Error creating student: ' + data.error);
        }
      } catch (error) {
        showCustomPopup('error', 'Error', 'Error creating student: ' + error.message);
      }
    }

    function continueToScreening() {
      closeModal();
      loadStudentData(window.newStudentData.student, window.newStudentData.requiredScreenings);
    }

    function closeModal() {
      document.getElementById('newStudentModal').style.display = 'none';
    }

    // Show edit student modal
    function showEditStudentModal(student, missingFields) {
      // Store current student for later use
      window.editingStudent = student;
      
      // Populate modal
      document.getElementById('editStudentId').textContent = student.unique_id;
      document.getElementById('editFirstName').value = (student.first_name && student.first_name.toLowerCase() !== 'null') ? student.first_name : '';
      document.getElementById('editLastName').value = (student.last_name && student.last_name.toLowerCase() !== 'null') ? student.last_name : '';
      document.getElementById('editGrade').value = (student.grade && student.grade.toLowerCase() !== 'null') ? student.grade : '';
      document.getElementById('editGender').value = (student.gender && student.gender.toLowerCase() !== 'null') ? student.gender : '';
      document.getElementById('editSchool').value = (student.school && student.school.toLowerCase() !== 'null') ? student.school : '';
      document.getElementById('editTeacher').value = (student.teacher && student.teacher.toLowerCase() !== 'null') ? student.teacher : '';
      document.getElementById('editDOB').value = (student.dob && student.dob.toLowerCase() !== 'null') ? student.dob : '';
      document.getElementById('editStatus').value = (student.status && student.status.toLowerCase() !== 'null') ? student.status : '';
      
      // Populate school dropdown if not already done
      const editSchoolSelect = document.getElementById('editSchool');
      if (editSchoolSelect.options.length <= 1) {
        schools.forEach(school => {
          const option = new Option(school.name, school.name);
          editSchoolSelect.add(option);
        });
      }
      
      // Highlight missing fields
      missingFields.forEach(field => {
        const fieldMap = {
          'first_name': 'editFirstName',
          'last_name': 'editLastName',
          'grade': 'editGrade',
          'gender': 'editGender',
          'school': 'editSchool',
          'dob': 'editDOB',
          'status': 'editStatus'
        };
        const inputId = fieldMap[field.key];
        if (inputId) {
          const input = document.getElementById(inputId);
          input.classList.add('border-red-500', 'bg-red-50');
        }
      });
      
      // Show modal
      document.getElementById('editStudentModal').classList.remove('hidden');
    }

    // Close edit student modal
    function closeEditStudentModal() {
      document.getElementById('editStudentModal').classList.add('hidden');
      window.editingStudent = null;
    }

    // Save student updates
    async function saveStudentUpdates() {
      const student = window.editingStudent;
      if (!student) return;
      
      // Get form values
      const updates = {
        firstName: document.getElementById('editFirstName').value.trim(),
        lastName: document.getElementById('editLastName').value.trim(),
        grade: document.getElementById('editGrade').value.trim(),
        gender: document.getElementById('editGender').value,
        school: document.getElementById('editSchool').value,
        teacher: document.getElementById('editTeacher').value.trim(),
        dob: document.getElementById('editDOB').value,
        status: document.getElementById('editStatus').value
      };
      
      // Validate required fields
      if (!updates.firstName || !updates.lastName || !updates.grade || 
          !updates.gender || !updates.school || !updates.dob || !updates.status) {
        showCustomPopup('warning', 'Missing Information', 'Please fill in all required fields (marked with *)');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/students/${student.unique_id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });
        
        const data = await response.json();
        
        if (data.success) {
          showCustomPopup('success', 'Updated!', 'Student information has been updated successfully');
          closeEditStudentModal();
          
          // Reload student data with updated info
          const updatedStudent = data.student;
          const requiredScreenings = {
            vision: true,
            hearing: true,
            acanthosis: false,
            scoliosis: false
          };
          loadStudentData(updatedStudent, requiredScreenings);
        } else {
          showCustomPopup('error', 'Update Failed', 'Error updating student: ' + data.error);
        }
      } catch (error) {
        showCustomPopup('error', 'Update Error', 'Error updating student: ' + error.message);
      }
    }

    // Validate student data completeness
    function validateStudentData(student) {
      const requiredFields = [
        { key: 'first_name', label: 'First Name' },
        { key: 'last_name', label: 'Last Name' },
        { key: 'grade', label: 'Grade' },
        { key: 'gender', label: 'Gender' },
        { key: 'school', label: 'School' },
        { key: 'dob', label: 'Date of Birth' },
        { key: 'status', label: 'Status' }
      ];
      
      const missingFields = [];
      
      for (const field of requiredFields) {
        const value = student[field.key];
        // Check for empty, null, undefined, or "Null" string values
        if (!value || value.trim() === '' || value.toLowerCase() === 'null') {
          missingFields.push(field);
        }
      }
      
      return {
        isComplete: missingFields.length === 0,
        missingFields: missingFields
      };
    }

    // Load student data
    function loadStudentData(student, requiredScreenings) {
      // Validate student data completeness
      const validation = validateStudentData(student);
      
      if (!validation.isComplete) {
        // Show edit modal for incomplete data
        showEditStudentModal(student, validation.missingFields);
        return; // Don't proceed with loading until data is complete
      }
      
      currentStudent = student;
      
      // Display student info
      document.getElementById('displayStudentId').textContent = student.unique_id;
      document.getElementById('displayName').textContent = `${student.first_name} ${student.last_name}`;
      document.getElementById('displayDetails').textContent = `${student.grade} | ${student.gender} | ${student.school}`;
      document.getElementById('displayAdditional').textContent = `${student.teacher} | ${student.dob} | ${student.status}`;
      
      // Show sections (screeningDetails is always visible, no need to show it)
      document.getElementById('studentInfo').classList.remove('hidden');
      document.getElementById('absentSection').classList.remove('hidden');
      document.getElementById('screeningTests').classList.remove('hidden');
      document.getElementById('notesSection').classList.remove('hidden');
      document.getElementById('submitSection').classList.remove('hidden');
      
      // Ensure all screening sections are visible
      document.getElementById('screeningTests').style.display = 'block';
      
      // Show/hide required badges and auto-open required sections
      if (requiredScreenings) {
        // Vision
        if (requiredScreenings.vision) {
          document.getElementById('visionBadge').style.display = 'inline-block';
          openAccordion('vision');
        } else {
          document.getElementById('visionBadge').style.display = 'none';
        }
        
        // Hearing
        if (requiredScreenings.hearing) {
          document.getElementById('hearingBadge').style.display = 'inline-block';
          openAccordion('hearing');
        } else {
          document.getElementById('hearingBadge').style.display = 'none';
        }
        
        // Acanthosis
        if (requiredScreenings.acanthosis) {
          document.getElementById('acanthosisBadge').style.display = 'inline-block';
          openAccordion('acanthosis');
        } else {
          document.getElementById('acanthosisBadge').style.display = 'none';
        }
        
        // Scoliosis
        if (requiredScreenings.scoliosis) {
          document.getElementById('scoliosisBadge').style.display = 'inline-block';
          openAccordion('scoliosis');
        } else {
          document.getElementById('scoliosisBadge').style.display = 'none';
        }
      }
      
      // Set default screening type for all individual sections
      document.getElementById('visionDay1Type').value = 'initial';
      document.getElementById('hearingDay1Type').value = 'initial';
      document.getElementById('acanthosisDay1Type').value = 'initial';
      document.getElementById('scoliosisDay1Type').value = 'initial';
      
      // Scroll to student info
      document.getElementById('studentInfo').scrollIntoView({ behavior: 'smooth' });
    }

    // Toggle accordion
    function toggleAccordion(section) {
      const accordion = document.querySelector(`[data-section="${section}"]`);
      const content = accordion.querySelector('.accordion-content');
      const isOpen = content.classList.contains('open');
      
      // Toggle just this accordion (don't close others)
      if (isOpen) {
        // Close this accordion
        content.classList.remove('open');
        accordion.classList.remove('open');
      } else {
        // Open this accordion
        content.classList.add('open');
        accordion.classList.add('open');
      }
    }

    function openAccordion(section) {
      const accordion = document.querySelector(`[data-section="${section}"]`);
      const content = accordion.querySelector('.accordion-content');
      content.classList.add('open');
      accordion.classList.add('open');
    }

    // Apply global screening type
    function applyGlobalScreeningType() {
      const type = document.getElementById('globalScreeningType').value;
      if (!type) return;
      
      document.getElementById('visionDay1Type').value = type;
      document.getElementById('hearingDay1Type').value = type;
      document.getElementById('acanthosisDay1Type').value = type;
      document.getElementById('scoliosisDay1Type').value = type;
    }

    // Vision result changed
    function visionResultChanged(result) {
      if (result === 'pass') {
        document.getElementById('visionRightEye').value = '20';
        document.getElementById('visionLeftEye').value = '20';
      } else {
        document.getElementById('visionRightEye').value = '';
        document.getElementById('visionLeftEye').value = '';
      }
    }

    // Hearing result changed
    function hearingResultChanged(result) {
      const freqSection = document.getElementById('hearingFrequencies');
      if (result === 'pass') {
        freqSection.classList.add('hidden');
      } else {
        freqSection.classList.remove('hidden');
      }
    }

    // Absent checkbox changed
    function absentChanged(checked) {
      const screeningTests = document.getElementById('screeningTests');
      const sections = ['vision', 'hearing', 'acanthosis', 'scoliosis'];
      
      if (checked) {
        // Close all screening sections
        sections.forEach(section => {
          const accordion = document.querySelector(`[data-section="${section}"]`);
          if (accordion && accordion.classList.contains('open')) {
            toggleAccordion(section);
          }
        });
        
        // Gray out the entire screening tests section
        if (screeningTests) {
          screeningTests.style.opacity = '0.5';
          screeningTests.style.pointerEvents = 'none';
          screeningTests.style.filter = 'grayscale(100%)';
        }
      } else {
        // Remove gray out effect
        if (screeningTests) {
          screeningTests.style.opacity = '1';
          screeningTests.style.pointerEvents = 'auto';
          screeningTests.style.filter = 'none';
        }
      }
    }

    // Submit screening
    async function submitScreening() {
      if (!currentStudent) {
        showCustomPopup('warning', 'No Student Selected', 'Please search for or create a student first');
        return;
      }

      // Check if screener name is selected
      const screenerName = document.getElementById('screenerName').value.trim();
      if (!screenerName) {
        showCustomPopup('warning', 'Missing Screener Name', 'Please select a screener name before submitting.');
        return;
      }
      
      // Check if student is absent - if so, skip screening validation
      const isAbsent = document.getElementById('absent').checked;
      
      if (!isAbsent) {
        // Check if at least ONE section is open and has data
        const visionData = getVisionData();
        const hearingData = getHearingData();
        const acanthosisData = getAcanthosisData();
        const scoliosisData = getScoliosisData();
        
        const hasAnyData = visionData || hearingData || acanthosisData || scoliosisData;
        
        if (!hasAnyData) {
          showCustomPopup('warning', 'Incomplete Screening', 'Please complete at least one screening section before submitting.');
          return;
        }
      }
      
      // Check if any OPENED sections are incomplete (skip if absent)
      const incompleteSections = [];
      
      if (!isAbsent) {
        // Vision - if accordion is open but no result selected
        const visionAccordion = document.querySelector('[data-section="vision"]');
        if (visionAccordion?.classList.contains('open')) {
          const visionResult = document.querySelector('input[name="visionResult"]:checked');
          if (!visionResult) {
            incompleteSections.push('Vision');
          }
        }
        
        // Hearing - if accordion is open but no result selected
        const hearingAccordion = document.querySelector('[data-section="hearing"]');
        if (hearingAccordion?.classList.contains('open')) {
          const hearingResult = document.querySelector('input[name="hearingResult"]:checked');
          if (!hearingResult) {
            incompleteSections.push('Hearing');
          }
        }
        
        // Acanthosis - if accordion is open but no result selected
        const acanthosisAccordion = document.querySelector('[data-section="acanthosis"]');
        if (acanthosisAccordion?.classList.contains('open')) {
          const acanthosisResult = document.querySelector('input[name="acanthosisResult"]:checked');
          if (!acanthosisResult) {
            incompleteSections.push('Acanthosis');
          }
        }
        
        // Scoliosis - if accordion is open but no result selected
        const scoliosisAccordion = document.querySelector('[data-section="scoliosis"]');
        if (scoliosisAccordion?.classList.contains('open')) {
          const scoliosisResult = document.querySelector('input[name="scoliosisResult"]:checked');
          if (!scoliosisResult) {
            incompleteSections.push('Scoliosis');
          }
        }
      }
      
      // If any opened sections are incomplete, prevent submission
      if (incompleteSections.length > 0) {
        showCustomPopup('warning', 'Incomplete Sections', `Please complete the following open sections or close them before submitting:\n- ${incompleteSections.join('\n- ')}`);
        return;
      }

      const payload = buildPayload();
      
      try {
        const response = await fetch(`${API_BASE}/screenings${CACHE_BUST}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showCustomPopup('success', 'Success!', 'Screening results saved successfully!', {
            confirmText: 'Continue',
            onConfirm: () => {
              showCustomPopup('info', 'Continue Screening?', 'Would you like to screen another student?', {
                showCancel: true,
                confirmText: 'Yes',
                cancelText: 'No',
                onConfirm: () => resetForm(),
                onCancel: () => {}
              });
            }
          });
        } else {
          showCustomPopup('error', 'Error', 'Error saving: ' + result.error);
        }
      } catch (error) {
        showCustomPopup('error', 'Submission Error', 'Error submitting: ' + error.message);
      }
    }

    // Build payload
    function buildPayload() {
      const globalScreeningType = document.getElementById('globalScreeningType').value;
      const screeningDate = document.getElementById('screeningDate').value;
      const screenerName = document.getElementById('screenerName').value;
      const wasAbsent = document.getElementById('absent').checked;
      const notes = document.getElementById('notes').value;
      
      const payload = {
        uniqueId: currentStudent.unique_id,
        screeningDate: screeningDate,
        was_absent: wasAbsent,
        notes: notes || null
      };
      
      // Determine if this is initial or rescreen based on global type
      const isInitial = globalScreeningType === 'initial';
      const testKey = isInitial ? 'initial' : 'rescreen';
      
      // Vision data
      const visionData = getVisionData();
      if (visionData || true) {  // Always include to preserve structure
        payload.vision = {
          [testKey]: visionData ? {
            screener: screenerName,
            date: screeningDate,
            glasses: visionData.glasses || null,
            rightEye: visionData.rightEye || null,
            leftEye: visionData.leftEye || null,
            result: visionData.result || null
          } : null
        };
      }
      
      // Hearing data
      const hearingData = getHearingData();
      if (hearingData || true) {  // Always include to preserve structure
        payload.hearing = {
          [testKey]: hearingData ? {
            screener: screenerName,
            date: screeningDate,
            result: hearingData.result || null,
            right1000: hearingData.right1000 || null,
            right2000: hearingData.right2000 || null,
            right4000: hearingData.right4000 || null,
            left1000: hearingData.left1000 || null,
            left2000: hearingData.left2000 || null,
            left4000: hearingData.left4000 || null
          } : null
        };
      }
      
      // Acanthosis data
      const acanthosisData = getAcanthosisData();
      if (acanthosisData || true) {  // Always include to preserve structure
        payload.acanthosis = {
          [testKey]: acanthosisData ? {
            screener: screenerName,
            date: screeningDate,
            result: acanthosisData.result || null
          } : null
        };
      }
      
      // Scoliosis data
      const scoliosisData = getScoliosisData();
      if (scoliosisData || true) {  // Always include to preserve structure
        payload.scoliosis = {
          [testKey]: scoliosisData ? {
            screener: screenerName,
            date: screeningDate,
            result: scoliosisData.result || null,
            observations: scoliosisData.observations || null
          } : null
        };
      }

      return payload;
    }

    function getVisionData() {
      const visionAccordion = document.querySelector('[data-section="vision"]');
      if (!visionAccordion?.classList.contains('open')) return null;
      
      const result = document.querySelector('input[name="visionResult"]:checked');
      if (!result) return null;
      
      const glasses = document.querySelector('input[name="visionGlasses"]:checked')?.value || 'no';
      
      return {
        glasses: glasses,
        rightEye: document.getElementById('visionRightEye').value || '',
        leftEye: document.getElementById('visionLeftEye').value || '',
        result: result.value
      };
    }

    function getHearingData() {
      const hearingAccordion = document.querySelector('[data-section="hearing"]');
      if (!hearingAccordion?.classList.contains('open')) return null;
      
      const result = document.querySelector('input[name="hearingResult"]:checked');
      if (!result) return null;

      const data = {
        result: result.value
      };

      if (result.value === 'fail') {
        const checkboxes = document.querySelectorAll('.hearing-freq:checked');
        checkboxes.forEach(cb => {
          const ear = cb.dataset.ear;
          const freq = cb.dataset.freq;
          data[`${ear}${freq}`] = 'fail';
        });
      } else {
        data.right1000 = 'pass';
        data.right2000 = 'pass';
        data.right4000 = 'pass';
        data.left1000 = 'pass';
        data.left2000 = 'pass';
        data.left4000 = 'pass';
      }

      return data;
    }

    function getAcanthosisData() {
      const acanthosisAccordion = document.querySelector('[data-section="acanthosis"]');
      if (!acanthosisAccordion?.classList.contains('open')) return null;
      
      const result = document.querySelector('input[name="acanthosisResult"]:checked');
      if (!result) return null;

      return {
        result: result.value
      };
    }

    function getScoliosisData() {
      const scoliosisAccordion = document.querySelector('[data-section="scoliosis"]');
      if (!scoliosisAccordion?.classList.contains('open')) return null;
      
      const result = document.querySelector('input[name="scoliosisResult"]:checked');
      if (!result) return null;
      
      const observations = Array.from(document.querySelectorAll('input[name="scoliosisObs"]:checked'))
        .map(cb => cb.value);
      
      return {
        result: result.value,
        observations: observations.join(', ')
      };
    }

    // Reset form
    function resetForm() {
      // Only clear student-specific fields, NOT screening details
      const studentFields = ['searchId', 'searchLastName', 'searchSchool', 'firstName', 'lastName', 'grade', 'gender', 'newStudentSchool', 'teacher', 'dob', 'status'];
      studentFields.forEach(id => {
        const el = document.getElementById(id);
        if (el && (el.type === 'radio' || el.type === 'checkbox')) {
          el.checked = false;
        } else if (el) {
          el.value = '';
        }
      });
      
      // Clear screening test fields only
      const screeningFields = ['visionRightEye', 'visionLeftEye', 'visionNotes', 'hearingNotes', 'acanthosisNotes', 'scoliosisNotes'];
      screeningFields.forEach(id => {
        const el = document.getElementById(id);
        if (el && (el.type === 'radio' || el.type === 'checkbox')) {
          el.checked = false;
        } else if (el) {
          el.value = '';
        }
      });
      
      // Clear radio buttons in screening tests
      document.querySelectorAll('input[name="visionResult"], input[name="visionGlasses"], input[name="hearingResult"], input[name="acanthosisResult"], input[name="scoliosisResult"]').forEach(el => el.checked = false);
      document.querySelectorAll('.hearing-freq').forEach(el => el.checked = false);
      
      // Clear scoliosis observation checkboxes
      document.querySelectorAll('input[name="scoliosisObs"]').forEach(el => el.checked = false);
      
      // Clear notes
      document.getElementById('notes').value = '';
      
      // Reset absent checkbox
      document.getElementById('absent').checked = false;
      absentChanged(false);
      
      // Reset to search tab
      switchTab('search');
      
      // Hide sections except student search and screening details
      document.getElementById('studentInfo').classList.add('hidden');
      document.getElementById('absentSection').classList.add('hidden');
      document.getElementById('screeningTests').classList.add('hidden');
      document.getElementById('notesSection').classList.add('hidden');
      document.getElementById('submitSection').classList.add('hidden');
      // NOTE: screeningDetails stays visible and keeps its values
      
      // Show all accordions
      document.querySelectorAll('[data-section]').forEach(el => el.style.display = '');
      
      // Reset absent state
      document.getElementById('absent').checked = false;
      absentChanged(false);
      
      currentStudent = null;
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Custom Popup Functions
    function showCustomPopup(type, title, message, options = {}) {
      const modal = document.getElementById('customModal');
      const modalIcon = document.getElementById('modalIcon');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      const modalCancelBtn = document.getElementById('modalCancelBtn');
      const modalConfirmBtn = document.getElementById('modalConfirmBtn');

      // Set icon based on type
      modalIcon.className = 'w-8 h-8 mr-3';
      switch(type) {
        case 'success':
          modalIcon.classList.add('modal-success-icon');
          modalIcon.innerHTML = '‚úì';
          break;
        case 'error':
          modalIcon.classList.add('modal-error-icon');
          modalIcon.innerHTML = '‚úï';
          break;
        case 'warning':
          modalIcon.classList.add('modal-warning-icon');
          modalIcon.innerHTML = '‚ö†';
          break;
        case 'info':
        default:
          modalIcon.classList.add('modal-info-icon');
          modalIcon.innerHTML = '‚Ñπ';
          break;
      }

      // Set content
      modalTitle.textContent = title;
      modalMessage.textContent = message;

      // Handle buttons
      if (options.showCancel) {
        modalCancelBtn.classList.remove('hidden');
        modalCancelBtn.textContent = options.cancelText || 'Cancel';
        modalCancelBtn.onclick = () => {
          hideCustomPopup();
          if (options.onCancel) options.onCancel();
        };
      } else {
        modalCancelBtn.classList.add('hidden');
      }

      modalConfirmBtn.textContent = options.confirmText || 'OK';
      modalConfirmBtn.onclick = () => {
        hideCustomPopup();
        if (options.onConfirm) options.onConfirm();
      };

      // Show modal
      modal.classList.remove('hidden');
      
      // Auto-hide after delay if specified
      if (options.autoHide) {
        setTimeout(() => {
          hideCustomPopup();
        }, options.autoHide);
      }
    }

    function hideCustomPopup() {
      const modal = document.getElementById('customModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Close modal when clicking outside
    const customModal = document.getElementById('customModal');
    if (customModal) {
      customModal.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          hideCustomPopup();
        }
      });
    }

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideCustomPopup();
      }
    });
  </script>

  <!-- Custom Popup Modal -->
  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
      <div class="flex items-center mb-4">
        <div id="modalIcon" class="w-8 h-8 mr-3"></div>
        <h3 id="modalTitle" class="text-lg font-semibold text-gray-900"></h3>
      </div>
      <p id="modalMessage" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end space-x-3">
        <button id="modalCancelBtn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 hidden">
          Cancel
        </button>
        <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          OK
        </button>
      </div>
    </div>
  </div>

  <style>
    #customModal {
      backdrop-filter: blur(4px);
    }
    
    .modal-success-icon {
      background: #10B981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-error-icon {
      background: #EF4444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-warning-icon {
      background: #F59E0B;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-info-icon {
      background: #3B82F6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
  
</body>
</html>
